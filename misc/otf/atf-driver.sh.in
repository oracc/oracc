#!/bin/sh
project=$1
pqx=$2
atffile=$3
workdir=$4

if [ "$project" == "" ] || [ "$pqx" == "" ] || [ "$atffile" == "" ] || [ "$workdir" == "" ]; then
    echo $0: please give PROJECT PQX-ID PQX-PATH PDFDIR on commandline
    exit 1
fi

projhyph=`/bin/echo -n $project | tr / -`
otfname="$pqx.otf"
pdfname="$projhyph:$pqx.pdf"
pdfwork="$workdir/$pdfname"

>&2 echo $0: pdf name $pdfwork

if [ -r $pdfwork ]; then
    >&2 echo $0: returning existing pdf $pdfwork
    /bin/echo -n $pdfwork
    exit 0
fi

xmd=`dirname $atffile`/$pqx.xmd
xmdo=@@ORACC_BUILDS@@/www/$project/xmdoutline.xsl
if [ ! -r $xmdo ]; then
    parent=`/bin/echo -n $project | cut -d/ -f1`
    xmdo=@@ORACC_BUILDS@@/www/$parent/xmdoutline.xsl
    if [ ! -r $xmdo ]; then
	xmdo=@@ORACC_BUILDS@@/lib/scripts/p3-xmd-div.xsl
    fi
fi

(cd $workdir;
 cat >$otfname <<EOF
@document

@project $project

@title Oracc Edition of $project : $atf

@section introduction

@p This PDF was generated by Oracc.
EOF

xsltproc --stringparam project $project $xmdo $xmd | \
    xsltproc @@ORACC_BUILDS@@/lib/scripts/web-pdf-xmd.xsl - >>$otfname

cat >>$otfname <<EOF
@end section

@section edition
    
@atffile $atffile

@end section

@end document
EOF

pdf-driver.sh $project $pqx $pdfname
)
/bin/echo -n $pdfwork
